<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Houston Karen Command Center</title>

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    #map { height: 100%; width: 100%; }

    #title {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.65);
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 13px;
      z-index: 1000;
    }
  </style>
</head>

<body>

<div id="title">Houston Karen Command Center</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
console.log("PRECISION BUILD");

const HOME_LAT = 29.828103;
const HOME_LON = -95.426829;
const RADIUS_MILES = 1.0;

const apiURL =
  "https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query?" +
  "where=StateCodeName='Active' AND NOT CaseType LIKE '%Traffic%'" +
  "&outFields=CaseType,Status,Latitude,Longitude,IncidentAddress,CaseNumber" +
  "&resultRecordCount=2000&f=json";

const map = L.map("map").setView([HOME_LAT, HOME_LON], 16);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

/* ðŸ  EXACT HQ */
L.marker([HOME_LAT, HOME_LON])
  .addTo(map)
  .bindPopup("ðŸ  Karen HQ (Exact)")
  .openPopup();

/* ðŸ”µ Radius */
L.circle([HOME_LAT, HOME_LON], {
  radius: RADIUS_MILES * 1609.34,
  fillOpacity: 0.04
}).addTo(map);

let known = new Set();

function milesBetween(lat1, lon1, lat2, lon2) {
  const R = 3958.8;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function validCoord(lat, lon) {
  return (
    lat && lon &&
    lat > 29 && lat < 31 &&
    lon < -94 && lon > -96
  );
}

function plot(attrs) {
  const lat = Number(attrs.Latitude);
  const lon = Number(attrs.Longitude);

  if (!validCoord(lat, lon)) {
    console.log("Bad coord skipped:", attrs.CaseNumber);
    return;
  }

  const distance = milesBetween(HOME_LAT, HOME_LON, lat, lon);

  if (distance > RADIUS_MILES) return;

  const id = attrs.CaseNumber;
  if (known.has(id)) return;

  known.add(id);

  const marker = L.circleMarker([lat, lon], { radius: 8 })
    .addTo(map)
    .bindPopup(
      "<b>" + attrs.CaseType + "</b><br>" +
      "Status: " + attrs.Status + "<br>" +
      "Distance: " + distance.toFixed(2) + " mi<br>" +
      attrs.IncidentAddress
    );

  /* âœ¨ subtle animation */
  marker.setStyle({ opacity: 0, fillOpacity: 0 });
  setTimeout(() => marker.setStyle({ opacity: 1, fillOpacity: 0.7 }), 60);
}

function refresh() {
  fetch(apiURL)
    .then(r => r.json())
    .then(data => {
      const features = data.features || [];
      console.log("Records:", features.length);

      features.forEach(f => {
        const attrs = f.attributes;
        if (!attrs) return;

        /* ðŸ”¥ DEBUG your specific case */
        if (attrs.IncidentAddress &&
            attrs.IncidentAddress.includes("1062")) {
          console.log("FOUND YOUR ADDRESS:", attrs);
        }

        plot(attrs);
      });
    });
}

refresh();
setInterval(refresh, 30000);
</script>

</body>
</html>
