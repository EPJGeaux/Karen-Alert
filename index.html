<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Houston Karen Command Center</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
    }

    #map {
      height: 100%;
      width: 100%;
    }

    #controls {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      z-index: 1000;
      line-height: 1.6;
      font-size: 14px;
    }

    #controls label {
      display: block;
      cursor: pointer;
    }

    #title {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.65);
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 13px;
      z-index: 1000;
    }
  </style>
</head>

<body>

<div id="controls">
  <strong>Hyper-Local Chaos</strong>
  <label><input type="checkbox" value="parking" checked> ðŸš— Parking Drama</label>
  <label><input type="checkbox" value="trash" checked> ðŸ—‘ Trash Crimes</label>
  <label><input type="checkbox" value="noise" checked> ðŸ”Š Noise Meltdowns</label>
  <label><input type="checkbox" value="other" checked> ðŸŒª Other Chaos</label>
</div>

<div id="title">Houston Karen Command Center</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  console.log("Karen Command Center Booting");

  const HOME = {
    lat: 29.828103,
    lon: -95.426829
  };

  const RADIUS_MILES = 1.0;   // â† Upgraded paranoia radius ðŸ˜†

  const apiURL =
    "https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query?where=1%3D1&outFields=CaseType,Status,Latitude,Longitude,IncidentAddress&resultRecordCount=1000&f=json";

  const map = L.map("map").setView([HOME.lat, HOME.lon], 14);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Houston Chaos Engine"
  }).addTo(map);

  L.marker([HOME.lat, HOME.lon])
    .addTo(map)
    .bindPopup("ðŸ  Karen HQ")
    .openPopup();

  let markers = [];
  let cached = [];

  function milesBetween(lat1, lon1, lat2, lon2) {
    const R = 3958.8;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI/180) *
      Math.cos(lat2 * Math.PI/180) *
      Math.sin(dLon/2) * Math.sin(dLon/2);

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function getFilters() {
    return new Set(
      [...document.querySelectorAll("#controls input:checked")]
        .map(cb => cb.value)
    );
  }

  function matches(caseType, filters) {
    const type = (caseType || "").toLowerCase();

    const parkingMatch =
      type.includes("parking") ||
      type.includes("vehicle") ||
      type.includes("parked");

    const trashMatch =
      type.includes("trash") ||
      type.includes("garbage") ||
      type.includes("debris");

    const noiseMatch =
      type.includes("noise") ||
      type.includes("sound") ||
      type.includes("loud");

    if (parkingMatch) return filters.has("parking");
    if (trashMatch) return filters.has("trash");
    if (noiseMatch) return filters.has("noise");

    return filters.has("other");
  }

  function clearMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }

  function render() {
    clearMarkers();
    const filters = getFilters();

    cached.forEach(attrs => {
      const lat = attrs.Latitude;
      const lon = attrs.Longitude;

      if (!lat || !lon) return;

      const distance = milesBetween(HOME.lat, HOME.lon, lat, lon);

      if (distance > RADIUS_MILES) return;
      if (!matches(attrs.CaseType, filters)) return;

      const marker = L.circleMarker([lat, lon], { radius: 7 })
