<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Houston Karen HQ Radar</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { height: 100%; width: 100%; }

    .panel {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: white;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      font-size: 14px;
      line-height: 1.4;
      width: 280px;
    }
    .row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .row input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 10px; }
    .row button { padding: 8px 10px; border: 0; border-radius: 10px; cursor: pointer; }
    .muted { color: #666; font-size: 12px; }
    label { display: block; cursor: pointer; margin-top: 6px; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f2f2f2; font-size: 12px; margin-left: 6px; }
    .footer {
      position: absolute;
      bottom: 15px;
      left: 15px;
      z-index: 1000;
      background: rgba(0,0,0,0.65);
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <div><strong>Active Karen Radar</strong> <span class="badge" id="countBadge">0</span></div>
    <div class="muted">Drag â€œKaren HQâ€ onto your exact house roof once. It saves.</div>

    <div class="row">
      <button id="recenterBtn">Recenter</button>
      <button id="clearBtn">Clear pins</button>
    </div>

    <div class="row" title="Paste CaseNumber365 or CaseNumber from the case page (not the GUID).">
      <input id="caseSearch" type="text" placeholder="Search Case # (e.g. 2300... or 1253...)">
      <button id="findBtn">Find</button>
    </div>

    <label>
      Radius: <span id="radiusLabel">1.00</span> mile
      <input id="radius" type="range" min="0.25" max="2.0" step="0.25" value="1.0" />
    </label>

    <label><input type="checkbox" id="showParking" checked> ğŸš— Parking-ish</label>
    <label><input type="checkbox" id="showTrash" checked> ğŸ—‘ Trash-ish</label>
    <label><input type="checkbox" id="showNoise" checked> ğŸ”Š Noise-ish</label>
    <label><input type="checkbox" id="showOther" checked> ğŸŒª Other chaos</label>

    <label class="muted" style="margin-top:10px;">
      <input type="checkbox" id="excludeTraffic" checked>
      Exclude traffic spam (signals/signs)
    </label>

    <div class="muted" id="statusLine" style="margin-top:10px;">Loadingâ€¦</div>
  </div>

  <div class="footer">Houston Karen HQ Radar</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- STARTING HQ (your coords) ---
    const DEFAULT_HOME = { lat: 29.828103, lon: -95.426829 };

    // --- HOUSTON 311 RECENT FEED (TABLE ID = 3) ---
    // Active cases only; keep fields we need.
    const apiURL =
      "https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query" +
      "?where=StateCodeName%3D'Active'" +
      "&outFields=CaseType,Status,Latitude,Longitude,IncidentAddress,CaseNumber365,CaseNumber,CreatedDate" +
      "&resultRecordCount=2000&f=json";

    // ----- Utilities -----
    const $ = (id) => document.getElementById(id);

    function loadHome() {
      const raw = localStorage.getItem("karen_home");
      if (!raw) return { ...DEFAULT_HOME };
      try {
        const obj = JSON.parse(raw);
        if (typeof obj.lat === "number" && typeof obj.lon === "number") return obj;
      } catch {}
      return { ...DEFAULT_HOME };
    }

    function saveHome(lat, lon) {
      localStorage.setItem("karen_home", JSON.stringify({ lat, lon }));
    }

    function milesBetween(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function looksLikeHoustonLatLon(lat, lon) {
      return lat > 29 && lat < 31 && lon < -94 && lon > -96;
    }

    function classify(caseType) {
      const t = (caseType || "").toLowerCase();
      const parking = t.includes("parking") || t.includes("vehicle") || t.includes("parked") || t.includes("tow");
      const trash   = t.includes("trash") || t.includes("garbage") || t.includes("debris") || t.includes("junk") || t.includes("litter");
      const noise   = t.includes("noise") || t.includes("loud") || t.includes("sound");
      if (parking) return "parking";
      if (trash) return "trash";
      if (noise) return "noise";
      return "other";
    }

    function isTrafficSpam(caseType) {
      const t = (caseType || "").toLowerCase();
      return t.includes("traffic signal") || t.includes("traffic sign") || t.includes("traffic");
    }

    // ----- Map -----
    let HOME = loadHome();
    let radiusMiles = 1.0;

    const map = L.map("map").setView([HOME.lat, HOME.lon], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    // HQ marker (draggable) + radius circle
    const hqMarker = L.marker([HOME.lat, HOME.lon], { draggable: true })
      .addTo(map)
      .bindPopup("ğŸ  Karen HQ (drag me onto the roof once)")
      .openPopup();

    const radiusCircle = L.circle([HOME.lat, HOME.lon], {
      radius: radiusMiles * 1609.34,
      fillOpacity: 0.05
    }).addTo(map);

    hqMarker.on("dragend", () => {
      const ll = hqMarker.getLatLng();
      HOME = { lat: ll.lat, lon: ll.lng };
      saveHome(HOME.lat, HOME.lon);
      radiusCircle.setLatLng([HOME.lat, HOME.lon]);
      map.panTo([HOME.lat, HOME.lon]);
      refresh(); // rerun filters immediately
    });

    // ----- Rendering state -----
    let markers = new Map();         // id -> marker
    let knownIds = new Set();        // for new-case animation
    let latestData = [];             // cached attributes

    function clearPins() {
      for (const m of markers.values()) map.removeLayer(m);
      markers.clear();
      $("countBadge").textContent = "0";
    }

    function passesToggles(cat) {
      if (cat === "parking") return $("showParking").checked;
      if (cat === "trash")   return $("showTrash").checked;
      if (cat === "noise")   return $("showNoise").checked;
      return $("showOther").checked;
    }

    function makeId(a) {
      return a.CaseNumber365 || a.CaseNumber || a.ObjectID || (a.IncidentAddress + "::" + a.CreatedDate);
    }

    function addOrUpdatePin(attrs) {
      const id = makeId(attrs);
      const lat = Number(attrs.Latitude);
      const lon = Number(attrs.Longitude);

      if (!looksLikeHoustonLatLon(lat, lon)) return;

      const dist = milesBetween(HOME.lat, HOME.lon, lat, lon);
      if (dist > radiusMiles) return;

      const cat = classify(attrs.CaseType);
      if (!passesToggles(cat)) return;

      if ($("excludeTraffic").checked && isTrafficSpam(attrs.CaseType)) return;

      if (markers.has(id)) return;

      const popup =
        `<b>${attrs.CaseType || "Unknown"}</b><br>` +
        `Status: ${attrs.Status || "Unknown"}<br>` +
        `Distance: ${dist.toFixed(2)} mi<br>` +
        `${attrs.IncidentAddress || ""}<br>` +
        `<span class="muted">CaseNumber365: ${attrs.CaseNumber365 || ""} | CaseNumber: ${attrs.CaseNumber || ""}</span>`;

      const marker = L.circleMarker([lat, lon], { radius: 7 }).addTo(map).bindPopup(popup);

      // New-case animation (subtle fade-in)
      marker.setStyle({ opacity: 0, fillOpacity: 0 });
      setTimeout(() => marker.setStyle({ opacity: 1, fillOpacity: 0.7 }), 60);

      markers.set(id, marker);
      if (!knownIds.has(id)) knownIds.add(id);
    }

    function render() {
      clearPins();
      for (const attrs of latestData) addOrUpdatePin(attrs);
      $("countBadge").textContent = String(markers.size);
    }

    async function refresh() {
      $("statusLine").textContent = "Refreshingâ€¦";
      try {
        const res = await fetch(apiURL);
        const data = await res.json();
        const features = data.features || [];
        latestData = features.map(f => f.attributes || {});
        $("statusLine").textContent = `Loaded ${features.length} active cases. Showing ${markers.size}.`;
        render();
        $("statusLine").textContent = `Loaded ${features.length} active cases. Showing ${markers.size}.`;
      } catch (e) {
        console.error(e);
        $("statusLine").textContent = "API error (check Console).";
      }
    }

    // ----- UI wiring -----
    $("radius").addEventListener("input", (e) => {
      radiusMiles = Number(e.target.value);
      $("radiusLabel").textContent = radiusMiles.toFixed(2);
      radiusCircle.setRadius(radiusMiles * 1609.34);
      render();
    });

    ["showParking","showTrash","showNoise","showOther","excludeTraffic"].forEach(id => {
      $(id).addEventListener("change", render);
    });

    $("recenterBtn").addEventListener("click", () => {
      map.setView([HOME.lat, HOME.lon], 16);
      hqMarker.setLatLng([HOME.lat, HOME.lon]);
      radiusCircle.setLatLng([HOME.lat, HOME.lon]);
    });

    $("clearBtn").addEventListener("click", () => {
      markers.forEach(m => map.removeLayer(m));
      markers.clear();
      $("countBadge").textContent = "0";
      $("statusLine").textContent = "Cleared pins. (Next refresh brings them back.)";
    });

    function findCase() {
      const q = $("caseSearch").value.trim();
      if (!q) return;

      // Search in cached data by CaseNumber365 / CaseNumber
      const hit = latestData.find(a =>
        String(a.CaseNumber365 || "").includes(q) ||
        String(a.CaseNumber || "").includes(q)
      );

      if (!hit) {
        alert("Not found in the public 'recent' feed. If the case is older than ~2 weeks or lacks coordinates, it won't appear here.");
        return;
      }

      const lat = Number(hit.Latitude), lon = Number(hit.Longitude);
      if (!looksLikeHoustonLatLon(lat, lon)) {
        alert("Found it, but it has no mappable Lat/Lon in the feed.");
        return;
      }

      // Ensure it's rendered regardless of toggles/radius (spotlight mode)
      const spotlight = L.circleMarker([lat, lon], { radius: 12 }).addTo(map)
        .bindPopup(`<b>ğŸ¯ FOUND CASE</b><br>${hit.CaseType}<br>${hit.IncidentAddress}`).openPopup();

      map.setView([lat, lon], 17);
      setTimeout(() => map.removeLayer(spotlight), 8000);
    }

    $("findBtn").addEventListener("click", findCase);
    $("caseSearch").addEventListener("keydown", (e) => {
      if (e.key === "Enter") findCase();
    });

    // init UI
    $("radiusLabel").textContent = radiusMiles.toFixed(2);

    // first load + polling
    refresh();
    setInterval(refresh, 30000);
  </script>
</body>
</html>
