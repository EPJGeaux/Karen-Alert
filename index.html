<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Karen Parking Radar (Daily Digest)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { height:100%; width:100%; }

    .panel{
      position:absolute; top:15px; right:15px; z-index:1000;
      background:#fff; padding:12px 14px; border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      font-size:14px; width:360px; line-height:1.35;
    }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    .row input[type="text"]{ flex:1; padding:8px; border:1px solid #ddd; border-radius:10px; }
    .row button{ padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; }
    label{ display:block; margin-top:8px; cursor:pointer; }
    .muted{ color:#666; font-size:12px; margin-top:6px; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f2f2; font-size:12px; margin-left:6px; }
    .footer{
      position:absolute; bottom:15px; left:15px; z-index:1000;
      background:rgba(0,0,0,.65); color:#fff; padding:8px 12px; border-radius:12px; font-size:13px;
    }
    .digest{
      margin-top:10px;
      padding:10px 10px;
      border-radius:12px;
      background:#f7f7ff;
      border:1px solid #e6e6ff;
      max-height:180px;
      overflow:auto;
      white-space:pre-wrap;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <div><strong>Karen Radar</strong> <span class="badge" id="shownBadge">0</span></div>
    <div class="muted">Drag ‚ÄúKaren HQ‚Äù onto the exact roof once. It saves.</div>

    <div class="row">
      <button id="refreshBtn">Refresh</button>
      <button id="recenterBtn">Recenter</button>
      <button id="clearBtn">Clear</button>
    </div>

    <div class="row">
      <input id="search" type="text" placeholder="Search keyword (address/type/case #)">
      <button id="findBtn">Find</button>
    </div>

    <label>
      Radius: <span id="radiusLabel">1.00</span> mile
      <input id="radius" type="range" min="0.25" max="2.0" step="0.25" value="1.0"/>
    </label>

    <label><input type="checkbox" id="parkingOnly" checked> Parking-ish only</label>
    <label><input type="checkbox" id="excludeTraffic" checked> Hide traffic spam</label>

    <div class="muted" id="diag">‚Ä¶</div>
    <div class="digest" id="digestBox">Daily digest will appear here.</div>
  </div>

  <div class="footer">Karen Parking Radar (Daily Digest)</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ==== HQ defaults (dragging overrides & persists) ====
    const DEFAULT_HOME = { lat: 29.828103, lon: -95.426829 };
    const $ = (id) => document.getElementById(id);

    function loadHome(){
      const raw = localStorage.getItem("karen_home");
      if(!raw) return { ...DEFAULT_HOME };
      try{ const o = JSON.parse(raw); if(typeof o.lat==="number" && typeof o.lon==="number") return o; }catch{}
      return { ...DEFAULT_HOME };
    }
    function saveHome(lat, lon){ localStorage.setItem("karen_home", JSON.stringify({lat, lon})); }

    // ==== Digest snapshot storage ====
    // We store the last ‚Äúdaily snapshot‚Äù keyed by date so you can get a real daily delta.
    const SNAP_KEY = "karen_daily_snap_v1";
    const LAST_DATE_KEY = "karen_daily_date_v1";

    function todayLocalYYYYMMDD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function isTrafficSpam(text){
      const t=(text||"").toLowerCase();
      return t.includes("traffic signal") || t.includes("traffic sign") || t.includes("traffic signals") || t.includes("traffic signs") || t.includes("traffic");
    }
    function isParkingish(text){
      const t=(text||"").toLowerCase();
      return (
        t.includes("park") ||
        t.includes("vehicle") ||
        t.includes("tow") ||
        t.includes("blocked driveway") ||
        t.includes("obstruction") ||
        t.includes("illegally parked") ||
        t.includes("abandoned vehicle") ||
        t.includes("junk motor vehicle")
      );
    }

    function milesToLatDeg(mi){ return mi / 69.0; }
    function milesToLonDeg(mi, lat){ return mi / (69.0 * Math.cos(lat * Math.PI/180)); }

    function makeCaseId(a){
      return String(a.CaseNumber365 || a.CaseNumber || a.ObjectID || (a.IncidentAddress||"") + "::" + (a.CreatedDate||""));
    }
    function normStatus(a){
      return (a.StateCodeName || a.Status || "").toLowerCase().trim();
    }
    function isOpenish(status){
      return status.includes("active") || status.includes("open") || status.includes("routed") || status.includes("acknowledged");
    }

    // ==== Map ====
    let HOME = loadHome();
    let radiusMiles = 1.0;

    const map = L.map("map").setView([HOME.lat, HOME.lon], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const hqMarker = L.marker([HOME.lat, HOME.lon], { draggable:true })
      .addTo(map)
      .bindPopup("üè† Karen HQ (drag me onto the exact roof)")
      .openPopup();

    const radiusCircle = L.circle([HOME.lat, HOME.lon], { radius: radiusMiles*1609.34, fillOpacity:0.05 }).addTo(map);

    hqMarker.on("dragend", async () => {
      const ll = hqMarker.getLatLng();
      HOME = { lat: ll.lat, lon: ll.lng };
      saveHome(HOME.lat, HOME.lon);
      radiusCircle.setLatLng([HOME.lat, HOME.lon]);
      map.panTo([HOME.lat, HOME.lon]);
      await refresh();
    });

    // ==== Pins ====
    let latest = [];
    let markers = new Map();

    function clearPins(){
      for(const m of markers.values()) map.removeLayer(m);
      markers.clear();
      $("shownBadge").textContent = "0";
    }

    function addPin(a){
      const lat = Number(a.Latitude);
      const lon = Number(a.Longitude);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;

      const id = makeCaseId(a);
      if(markers.has(id)) return;

      const title = a.CaseType || "311";
      const status = a.StateCodeName || a.Status || "Active";
      const address = a.IncidentAddress || "";

      const marker = L.circleMarker([lat, lon], { radius: 8 })
        .addTo(map)
        .bindPopup(
          `<b>${title}</b><br>` +
          `Status: ${status}<br>` +
          `${address}<br>` +
          `<span class="muted">CaseNumber365: ${a.CaseNumber365||""} | CaseNumber: ${a.CaseNumber||""}</span>`
        );

      markers.set(id, marker);
    }

    function render(){
      clearPins();

      const parkingOnly = $("parkingOnly").checked;
      const excludeTraffic = $("excludeTraffic").checked;

      for(const a of latest){
        const type = a.CaseType || "";
        if(excludeTraffic && isTrafficSpam(type)) continue;
        if(parkingOnly && !isParkingish(type)) continue;
        addPin(a);
      }

      $("shownBadge").textContent = String(markers.size);
    }

    function buildArcgisUrl(){
      const latPad = milesToLatDeg(radiusMiles) * 1.25;
      const lonPad = milesToLonDeg(radiusMiles, HOME.lat) * 1.25;

      const minLat = (HOME.lat - latPad).toFixed(6);
      const maxLat = (HOME.lat + latPad).toFixed(6);
      const minLon = (HOME.lon - lonPad).toFixed(6);
      const maxLon = (HOME.lon + lonPad).toFixed(6);

      // NOTE: Not filtering Active here so digest can detect closures *if present*.
      const where =
        `Latitude >= ${minLat} AND Latitude <= ${maxLat} AND Longitude >= ${minLon} AND Longitude <= ${maxLon}`;

      return (
        "https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query" +
        `?where=${encodeURIComponent(where)}` +
        "&outFields=CaseType,Status,StateCodeName,Latitude,Longitude,IncidentAddress,CaseNumber365,CaseNumber,CreatedDate,ClosedDate" +
        "&resultRecordCount=2000&f=json"
      );
    }

    function buildDailyDigest(currentParkingCases){
      const today = todayLocalYYYYMMDD();
      const lastDate = localStorage.getItem(LAST_DATE_KEY);
      const prevSnapRaw = localStorage.getItem(SNAP_KEY);
      const prevSnap = prevSnapRaw ? JSON.parse(prevSnapRaw) : {}; // {id: status}

      // Create today snapshot for parking-ish only
      const todaySnap = {};
      for (const c of currentParkingCases) todaySnap[c.id] = c.status;

      // Deltas
      const openNow = currentParkingCases.filter(c => isOpenish(c.status));
      const changed = [];
      const newlySeen = [];

      for (const c of currentParkingCases) {
        if (!prevSnap[c.id]) newlySeen.push(c);
        else if (prevSnap[c.id] !== c.status) changed.push({ ...c, before: prevSnap[c.id] });
      }

      // Missing cases (were in prev, not in today): likely closed or dropped from feed
      const missing = [];
      for (const prevId of Object.keys(prevSnap)) {
        if (!todaySnap[prevId]) missing.push(prevId);
      }

      let out = `üì¨ Daily Digest (${today})\n`;

      if (lastDate === today) out += "(Already generated today ‚Äî showing latest.)\n\n";
      else out += "\n";

      if (openNow.length === 0 && changed.length === 0 && newlySeen.length === 0 && missing.length === 0) {
        out += "‚úÖ No parking-ish drama detected near HQ.\n";
      } else {
        if (openNow.length) {
          out += `üöó Open parking-ish near HQ: ${openNow.length}\n`;
          openNow.slice(0, 6).forEach(c => out += `‚Ä¢ ${c.type} ‚Äî ${c.address} (${c.status})\n`);
          if (openNow.length > 6) out += `‚Ä¶and ${openNow.length - 6} more\n`;
          out += "\n";
        }

        if (changed.length) {
          out += `üîÅ Status changes: ${changed.length}\n`;
          changed.slice(0, 6).forEach(c => out += `‚Ä¢ ${c.type} ‚Äî ${c.address} (${c.before} ‚Üí ${c.status})\n`);
          if (changed.length > 6) out += `‚Ä¶and ${changed.length - 6} more\n`;
          out += "\n";
        }

        if (newlySeen.length) {
          out += `üÜï New since last digest: ${newlySeen.length}\n`;
          newlySeen.slice(0, 6).forEach(c => out += `‚Ä¢ ${c.type} ‚Äî ${c.address} (${c.status})\n`);
          if (newlySeen.length > 6) out += `‚Ä¶and ${newlySeen.length - 6} more\n`;
          out += "\n";
        }

        if (missing.length) {
          out += `üëª Disappeared since last digest: ${missing.length}\n`;
          out += "(Often means closed or aged out of the public ‚Äòrecent‚Äô feed.)\n";
        }
      }

      // Save snapshot once per day (or overwrite if you refresh later that day)
      localStorage.setItem(SNAP_KEY, JSON.stringify(todaySnap));
      localStorage.setItem(LAST_DATE_KEY, today);

      return out;
    }

    async function refresh(){
      $("diag").textContent = "Refreshing‚Ä¶";
      try{
        const url = buildArcgisUrl();
        const res = await fetch(url);
        const data = await res.json();

        const feats = data.features || [];
        const all = feats.map(f => f.attributes || {});
        latest = all;

        // Build digest based on parking-ish only (regardless of UI toggles)
        const parkingCases = all
          .filter(a => isParkingish(a.CaseType))
          .filter(a => !($("excludeTraffic").checked && isTrafficSpam(a.CaseType)))
          .map(a => ({
            id: makeCaseId(a),
            type: a.CaseType || "Parking-ish",
            status: normStatus(a),
            address: a.IncidentAddress || "",
          }));

        $("digestBox").textContent = buildDailyDigest(parkingCases);

        const sampleTypes = all.slice(0,5).map(a => a.CaseType).filter(Boolean).join(" | ");
        $("diag").innerHTML =
          `<div><b>ArcGIS</b> returned: ${feats.length} (bbox around HQ)</div>` +
          `<div>HQ: ${HOME.lat.toFixed(6)}, ${HOME.lon.toFixed(6)} | radius ${radiusMiles.toFixed(2)} mi</div>` +
          `<div class="muted">Sample types: ${sampleTypes || "(none)"}</div>`;

        render();
      }catch(e){
        console.error(e);
        $("diag").textContent = "API error. Open DevTools Console for details.";
      }
    }

    function find(){
      const q = $("search").value.trim().toLowerCase();
      if(!q) return;

      const hit = latest.find(a => (
        String(a.CaseNumber365||"").toLowerCase().includes(q) ||
        String(a.CaseNumber||"").toLowerCase().includes(q) ||
        String(a.IncidentAddress||"").toLowerCase().includes(q) ||
        String(a.CaseType||"").toLowerCase().includes(q)
      ));

      if(!hit){ alert("Not found in the current bbox results."); return; }

      const lat = Number(hit.Latitude), lon = Number(hit.Longitude);
      map.setView([lat, lon], 17);
      const spot = L.circleMarker([lat, lon], { radius: 14 }).addTo(map)
        .bindPopup("üéØ FOUND<br><b>" + (hit.CaseType||"") + "</b><br>" + (hit.IncidentAddress||""))
        .openPopup();
      setTimeout(() => map.removeLayer(spot), 8000);
    }

    // ==== UI wiring ====
    $("radiusLabel").textContent = radiusMiles.toFixed(2);

    $("radius").addEventListener("input", async (e) => {
      radiusMiles = Number(e.target.value);
      $("radiusLabel").textContent = radiusMiles.toFixed(2);
      radiusCircle.setRadius(radiusMiles * 1609.34);
      await refresh();
    });

    $("refreshBtn").addEventListener("click", refresh);
    $("recenterBtn").addEventListener("click", () => {
      map.setView([HOME.lat, HOME.lon], 16);
      hqMarker.setLatLng([HOME.lat, HOME.lon]);
      radiusCircle.setLatLng([HOME.lat, HOME.lon]);
    });
    $("clearBtn").addEventListener("click", () => {
      clearPins();
      $("diag").textContent = "Cleared pins. Hit Refresh.";
    });

    $("parkingOnly").addEventListener("change", render);
    $("excludeTraffic").addEventListener("change", async () => { render(); await refresh(); });

    $("findBtn").addEventListener("click", find);
    $("search").addEventListener("keydown", (e) => { if(e.key==="Enter") find(); });

    // init
    refresh();
  </script>
</body>
</html>

