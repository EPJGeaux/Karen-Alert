<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Karen Parking Radar</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { height: 100%; width: 100%; }

    .panel{
      position:absolute; top:15px; right:15px; z-index:1000;
      background:#fff; padding:12px 14px; border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      font-size:14px; width:320px; line-height:1.35;
    }
    .row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    .row input[type="text"]{ flex:1; padding:8px; border:1px solid #ddd; border-radius:10px; }
    .row button, .row select{ padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer; }
    label{ display:block; margin-top:8px; cursor:pointer; }
    .muted{ color:#666; font-size:12px; margin-top:6px; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f2f2; font-size:12px; margin-left:6px; }
    .footer{
      position:absolute; bottom:15px; left:15px; z-index:1000;
      background:rgba(0,0,0,.65); color:#fff; padding:8px 12px; border-radius:12px; font-size:13px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <div><strong>Karen Radar</strong> <span class="badge" id="shownBadge">0</span></div>
    <div class="muted">Drag ‚ÄúKaren HQ‚Äù onto your exact roof once. It saves.</div>

    <div class="row">
      <button id="refreshBtn">Refresh</button>
      <button id="recenterBtn">Recenter</button>
      <button id="clearBtn">Clear</button>
    </div>

    <div class="row">
      <input id="search" type="text" placeholder="Search keyword (address/type/case #)">
      <button id="findBtn">Find</button>
    </div>

    <label>
      Radius: <span id="radiusLabel">1.00</span> mile
      <input id="radius" type="range" min="0.25" max="2.0" step="0.25" value="1.0"/>
    </label>

    <label><input type="checkbox" id="parkingOnly" checked> Parking-ish only</label>
    <label><input type="checkbox" id="excludeTraffic" checked> Hide traffic spam</label>

    <div class="muted" id="diag">
      ‚Ä¶
    </div>
  </div>

  <div class="footer">Karen Parking Radar</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ======= YOUR HQ (starting point; you can drag to lock it perfectly) =======
    const DEFAULT_HOME = { lat: 29.828103, lon: -95.426829 };
    const $ = (id) => document.getElementById(id);

    function loadHome(){
      const raw = localStorage.getItem("karen_home");
      if(!raw) return { ...DEFAULT_HOME };
      try{
        const o = JSON.parse(raw);
        if(typeof o.lat==="number" && typeof o.lon==="number") return o;
      }catch{}
      return { ...DEFAULT_HOME };
    }
    function saveHome(lat, lon){ localStorage.setItem("karen_home", JSON.stringify({lat, lon})); }

    // Miles -> degrees (rough, but perfect for a bounding box)
    function milesToLatDeg(mi){ return mi / 69.0; }
    function milesToLonDeg(mi, lat){ return mi / (69.0 * Math.cos(lat * Math.PI/180)); }

    function isTrafficSpam(text){
      const t=(text||"").toLowerCase();
      return t.includes("traffic signal") || t.includes("traffic sign") || t.includes("traffic signals") || t.includes("traffic signs");
    }
    function isParkingish(text){
      const t=(text||"").toLowerCase();
      // Houston doesn't always say "parking" ‚Äî this catches the usual suspects
      return t.includes("park") || t.includes("vehicle") || t.includes("tow") || t.includes("blocked driveway") || t.includes("obstruction");
    }

    // ======= Map =======
    let HOME = loadHome();
    let radiusMiles = 1.0;

    const map = L.map("map").setView([HOME.lat, HOME.lon], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const hqMarker = L.marker([HOME.lat, HOME.lon], { draggable:true })
      .addTo(map)
      .bindPopup("üè† Karen HQ (drag me onto the exact roof)")
      .openPopup();

    const radiusCircle = L.circle([HOME.lat, HOME.lon], { radius: radiusMiles*1609.34, fillOpacity:0.05 }).addTo(map);

    hqMarker.on("dragend", () => {
      const ll = hqMarker.getLatLng();
      HOME = { lat: ll.lat, lon: ll.lng };
      saveHome(HOME.lat, HOME.lon);
      radiusCircle.setLatLng([HOME.lat, HOME.lon]);
      map.panTo([HOME.lat, HOME.lon]);
      refresh();
    });

    // ======= Data + Pins =======
    let latest = [];          // raw attributes from ArcGIS
    let markers = new Map();  // caseId -> marker

    function clearPins(){
      for(const m of markers.values()) map.removeLayer(m);
      markers.clear();
      $("shownBadge").textContent = "0";
    }

    function addPin(a){
      const lat = Number(a.Latitude);
      const lon = Number(a.Longitude);
      if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;

      const id = String(a.CaseNumber365 || a.CaseNumber || a.ObjectID || (a.IncidentAddress||"") + "::" + (a.CreatedDate||""));
      if(markers.has(id)) return;

      const title = a.CaseType || "311";
      const status = a.StateCodeName || a.Status || "Active";
      const address = a.IncidentAddress || "";

      const marker = L.circleMarker([lat, lon], { radius: 8 })
        .addTo(map)
        .bindPopup(
          `<b>${title}</b><br>` +
          `Status: ${status}<br>` +
          `${address}<br>` +
          `<span class="muted">CaseNumber365: ${a.CaseNumber365||""} | CaseNumber: ${a.CaseNumber||""}</span>`
        );

      // pop-in animation
      marker.setStyle({ opacity:0, fillOpacity:0 });
      setTimeout(() => marker.setStyle({ opacity:1, fillOpacity:0.7 }), 60);

      markers.set(id, marker);
    }

    function render(){
      clearPins();

      let shown = 0;
      const parkingOnly = $("parkingOnly").checked;
      const excludeTraffic = $("excludeTraffic").checked;

      for(const a of latest){
        const type = a.CaseType || "";
        if(excludeTraffic && isTrafficSpam(type)) continue;
        if(parkingOnly && !isParkingish(type)) continue;

        addPin(a);
      }

      shown = markers.size;
      $("shownBadge").textContent = String(shown);
    }

    // ======= ArcGIS query: ACTIVE only + 1-mile bounding box =======
    // This is the big improvement: we query only around HQ so we don't hit transfer limits and we don't miss your neighborhood.
    function buildArcgisUrl(){
      const latPad = milesToLatDeg(radiusMiles) * 1.25;      // +25% slack
      const lonPad = milesToLonDeg(radiusMiles, HOME.lat) * 1.25;

      const minLat = (HOME.lat - latPad).toFixed(6);
      const maxLat = (HOME.lat + latPad).toFixed(6);
      const minLon = (HOME.lon - lonPad).toFixed(6);
      const maxLon = (HOME.lon + lonPad).toFixed(6);

      // Active only + bounding box based on Latitude/Longitude fields
      const where =
        `StateCodeName='Active' AND Latitude >= ${minLat} AND Latitude <= ${maxLat} AND Longitude >= ${minLon} AND Longitude <= ${maxLon}`;

      const url =
        "https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query" +
        `?where=${encodeURIComponent(where)}` +
        "&outFields=CaseType,Status,StateCodeName,Latitude,Longitude,IncidentAddress,CaseNumber365,CaseNumber,CreatedDate" +
        "&resultRecordCount=2000&f=json";

      return url;
    }

    async function refresh(){
      $("diag").textContent = "Refreshing‚Ä¶";
      try{
        const url = buildArcgisUrl();
        const res = await fetch(url);
        const data = await res.json();

        const feats = data.features || [];
        latest = feats.map(f => f.attributes || {});

        // Diagnostics so you can see if the API is returning anything near you at all
        const sampleTypes = latest.slice(0,5).map(a => a.CaseType).filter(Boolean).join(" | ");
        $("diag").innerHTML =
          `<div><b>ArcGIS</b> returned: ${feats.length} (bbox around HQ)</div>` +
          `<div>HQ: ${HOME.lat.toFixed(6)}, ${HOME.lon.toFixed(6)} | radius ${radiusMiles.toFixed(2)} mi</div>` +
          `<div class="muted">Sample types: ${sampleTypes || "(none)"}</div>`;

        render();
      }catch(e){
        console.error(e);
        $("diag").textContent = "API error. Open DevTools Console for details.";
      }
    }

    function find(){
      const q = $("search").value.trim().toLowerCase();
      if(!q) return;

      const hit = latest.find(a => {
        return (
          String(a.CaseNumber365||"").toLowerCase().includes(q) ||
          String(a.CaseNumber||"").toLowerCase().includes(q) ||
          String(a.IncidentAddress||"").toLowerCase().includes(q) ||
          String(a.CaseType||"").toLowerCase().includes(q)
        );
      });

      if(!hit){
        alert("Not found in the *public recent ArcGIS feed* for your 1-mile bbox. If the portal case is not mirrored here, it won‚Äôt be searchable by GUID.");
        return;
      }

      const lat = Number(hit.Latitude), lon = Number(hit.Longitude);
      map.setView([lat, lon], 17);
      // quick spotlight
      const spot = L.circleMarker([lat, lon], { radius: 14 }).addTo(map)
        .bindPopup("üéØ FOUND<br><b>" + (hit.CaseType||"") + "</b><br>" + (hit.IncidentAddress||""))
        .openPopup();
      setTimeout(() => map.removeLayer(spot), 8000);
    }

    // ======= UI wiring =======
    $("radiusLabel").textContent = radiusMiles.toFixed(2);

    $("radius").addEventListener("input", (e) => {
      radiusMiles = Number(e.target.value);
      $("radiusLabel").textContent = radiusMiles.toFixed(2);
      radiusCircle.setRadius(radiusMiles * 1609.34);
      refresh(); // rebuild bbox query
    });

    $("refreshBtn").addEventListener("click", refresh);
    $("recenterBtn").addEventListener("click", () => {
      map.setView([HOME.lat, HOME.lon], 16);
      hqMarker.setLatLng([HOME.lat, HOME.lon]);
      radiusCircle.setLatLng([HOME.lat, HOME.lon]);
    });
    $("clearBtn").addEventListener("click", () => {
      clearPins();
      $("diag").textContent = "Cleared pins. Hit Refresh.";
    });

    $("parkingOnly").addEventListener("change", render);
    $("excludeTraffic").addEventListener("change", render);

    $("findBtn").addEventListener("click", find);
    $("search").addEventListener("keydown", (e) => { if(e.key==="Enter") find(); });

    // init + auto refresh
    refresh();
    setInterval(refresh, 30000);
  </script>
</body>
</html>

