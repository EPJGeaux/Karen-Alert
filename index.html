<!DOCTYPE html>
<html>
<head>
  <title>Houston Karen Command Center</title>
  <meta charset="utf-8" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }

    #map {
      height: 100vh;
      width: 100vw;
    }

    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    #controls label {
      display: block;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }

    #title {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 1000;
    }
  </style>
</head>

<body>

<div id="controls">
  <strong>311 Chaos Filters</strong>
  <label><input type="checkbox" value="parking" checked> ðŸš— Parking Drama</label>
  <label><input type="checkbox" value="trash" checked> ðŸ—‘ Trash Crimes</label>
  <label><input type="checkbox" value="noise" checked> ðŸ”Š Noise Meltdowns</label>
  <label><input type="checkbox" value="other" checked> ðŸŒª Other Chaos</label>
</div>

<div id="title">Houston Karen Command Center</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const apiURL =
    "https://mycity.houstontx.gov/arcgis/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query?where=1%3D1&outFields=CaseType,Status,Latitude,Longitude,IncidentAddress&resultRecordCount=500&f=json";

  const map = L.map("map").setView([29.7604, -95.3698], 11);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â¯\\_(ãƒ„)_/Â¯"
  }).addTo(map);

  let allMarkers = [];
  let cachedFeatures = [];

  function matchesFilter(caseType, activeFilters) {
    const type = (caseType || "").toLowerCase();

    if (type.includes("parking")) return activeFilters.has("parking");
    if (type.includes("trash")) return activeFilters.has("trash");
    if (type.includes("noise")) return activeFilters.has("noise");

    return activeFilters.has("other");
  }

  function getActiveFilters() {
    return new Set(
      [...document.querySelectorAll("#controls input:checked")]
        .map(cb => cb.value)
    );
  }

  function clearMarkers() {
    allMarkers.forEach(m => map.removeLayer(m));
    allMarkers = [];
  }

  function renderMarkers(filters) {
    clearMarkers();

    cachedFeatures.forEach(attrs => {
      const lat = attrs.Latitude;
      const lon = attrs.Longitude;

      if (!lat || !lon) return;
      if (!matchesFilter(attrs.CaseType, filters)) return;

      const marker = L.circleMarker([lat, lon], { radius: 6 })
        .addTo(map)
        .bindPopup(`
          <b>${attrs.CaseType || "Unknown Chaos"}</b><br>
          Status: ${attrs.Status || "Unknown"}<br>
          ${attrs.IncidentAddress || ""}
        `);

      allMarkers.push(marker);
    });
  }

  fetch(apiURL)
    .then(res => res.json())
    .then(data => {
      const features = data.features || [];

      console.log("Records:", features.length);

      cachedFeatures = features.map(f => f.attributes || {});
      renderMarkers(getActiveFilters());
    })
    .catch(err => console.error("API Error:", err));

  document
    .querySelectorAll("#controls input")
    .forEach(cb =>
      cb.addEventListener("change", () =>
        renderMarkers(getActiveFilters())
      )
    );
</script>

</body>
</html>
