<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Whispers from the Plaza</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --paper: #fbfaf7;
      --ink: #1e1b18;
      --muted: #6f6a64;
      --accent: #b48a3c;
      --line: #e6e2db;
      --soft: #f3f1ec;
      --radius: 18px;
    }

    html, body { height: 100%; margin: 0; background: var(--paper); color: var(--ink); }
    body { display:flex; justify-content:center; }

    .page{
      width: min(1100px, 100%);
      padding: 28px 20px 40px;
      box-sizing: border-box;
      font-family: Georgia, "Times New Roman", serif;
    }

    .masthead{ text-align:center; margin-bottom: 18px; }
    .masthead h1{
      margin: 0;
      font-size: 48px;
      letter-spacing: 0.4px;
      font-family: "Georgia", serif;
    }
    .masthead p{
      margin: 10px 0 0;
      font-size: 15px;
      color: var(--muted);
      font-style: italic;
    }

    .rule{
      margin: 18px 0 18px;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--line), transparent);
    }

    .chaos{
      background: var(--soft);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 18px;
      text-align: center;
      margin-bottom: 14px;
    }
    .chaos strong{
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      display:block;
    }
    .chaos .count{
      font-size: 44px;
      margin-top: 8px;
      color: var(--accent);
      font-weight: 700;
      line-height: 1;
    }
    .chaos .label{
      margin-top: 6px;
      font-size: 14px;
      color: var(--muted);
    }

    /* Map card */
    .mapCard{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 12px;
    }
    .mapTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #fffdf8;
      color: var(--muted);
      font-size: 13px;
    }

    #map{
      height: 320px;
      width: 100%;
    }

    .controls{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      background: #fff;
      align-items: center;
    }
    .controls button,
    .controls input{
      font-family: inherit;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .controls label{
      display: inline-flex;
      align-items: center;
      gap: 7px;
      font-size: 13px;
      color: var(--muted);
      user-select:none;
    }
    .controls input[type="range"]{ width: 160px; }

    .digest{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 18px;
    }
    .digest h2{
      margin: 0 0 10px;
      font-size: 22px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .digest h2 .stamp{
      font-size: 12px;
      color: var(--muted);
      font-weight: normal;
    }
    .digest pre{
      white-space: pre-wrap;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 14px;
      line-height: 1.6;
      margin: 0;
      color: #2a2622;
    }

    a.caseLink{
      color: var(--accent);
      font-weight: 700;
      text-decoration: underline;
    }

    .leaflet-control-zoom a{
      background: #fff !important;
      border: 1px solid var(--line) !important;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="masthead">
      <h1>Whispers from the Plaza</h1>
      <p>Dearest reader, one‚Äôs neighborhood rarely rests quietly‚Ä¶</p>
    </div>

    <div class="rule"></div>

    <div class="chaos">
      <strong>Current State of Affairs</strong>
      <div class="count" id="chaosCount">‚Äî</div>
      <div class="label" id="chaosLabel">Awaiting intelligence‚Ä¶</div>
    </div>

    <div class="mapCard">
      <div class="mapTop">
        <span>üó∫Ô∏è The Situation Map</span>
        <span id="mapNote">Drag HQ if you must.</span>
      </div>

      <div id="map"></div>

      <div class="controls">
        <button id="refreshBtn">Refresh intelligence</button>

        <label><input type="checkbox" id="parkingOnly" checked> Parking only</label>
        <label><input type="checkbox" id="excludeTraffic" checked> Exclude traffic</label>

        <label>
          Radius
          <input id="radius" type="range" min="0.25" max="2.0" step="0.25" value="1.0" />
          <span id="radiusLabel">1.00</span> mi
        </label>
      </div>
    </div>

    <div class="digest">
      <h2>üì∞ The Daily Dispatch <span class="stamp" id="stamp">‚Äî</span></h2>
      <pre id="digestBox">Gathering whispers‚Ä¶</pre>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ===== SETTINGS =====
      const DEFAULT_HOME = { lat: 29.828103, lon: -95.426829 };
      const $ = (id) => document.getElementById(id);

      // Persist HQ so it won‚Äôt ‚Äúwander‚Äù
      function loadHome(){
        const raw = localStorage.getItem("whistledown_hq_v1");
        if(!raw) return { ...DEFAULT_HOME };
        try {
          const o = JSON.parse(raw);
          if (Number.isFinite(o.lat) && Number.isFinite(o.lon)) return o;
        } catch {}
        return { ...DEFAULT_HOME };
      }
      function saveHome(lat, lon){
        localStorage.setItem("whistledown_hq_v1", JSON.stringify({ lat, lon }));
      }

      let HOME = loadHome();
      let radiusMiles = Number($("radius").value || 1.0);

      // ===== HELPERS =====
      const trafficRe = /traffic|signal|sign|street\s*light|streetlight/i;
      const parkingRe = /park|parking|vehicle|tow|driveway|abandoned|obstruction|illegally\s*park/i;

      function isTraffic(type){ return trafficRe.test(type || ""); }
      function isParking(type){ return parkingRe.test(type || ""); }

      function milesToLatDeg(mi){ return mi / 69.0; }
      function milesToLonDeg(mi, lat){ return mi / (69.0 * Math.cos(lat * Math.PI/180)); }

      function makeCaseId(a){
        return String(a.CaseNumber365 || a.CaseNumber || a.ObjectID || (a.IncidentAddress||"") + "::" + (a.CreatedDate||""));
      }

      // Houston portal NOTE: it does NOT reliably accept query params to pre-fill case/address.
      // So we link to the status page + show the case number in the popup for copy/paste.
      const CASE_STATUS_URL = "https://houston311.powerappsportals.us/en-US/checkcasestatus/";

      function buildArcgisUrl(){
        const latPad = milesToLatDeg(radiusMiles) * 1.25;
        const lonPad = milesToLonDeg(radiusMiles, HOME.lat) * 1.25;

        const minLat = (HOME.lat - latPad).toFixed(6);
        const maxLat = (HOME.lat + latPad).toFixed(6);
        const minLon = (HOME.lon - lonPad).toFixed(6);
        const maxLon = (HOME.lon + lonPad).toFixed(6);

        const where =
          `Latitude >= ${minLat} AND Latitude <= ${maxLat} AND Longitude >= ${minLon} AND Longitude <= ${maxLon}`;

        const params = new URLSearchParams({
          where,
          outFields: "CaseType,StateCodeName,Status,IncidentAddress,Latitude,Longitude,CaseNumber365,CaseNumber,CreatedDate,ClosedDate",
          resultRecordCount: "2000",
          f: "json"
        });

        return "https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query?" + params.toString();
      }

      function setChaos(n){
        $("chaosCount").textContent = String(n);
        $("chaosLabel").textContent =
          n === 0 ? "A blessed silence." :
          n < 3 ? "A murmur among the hedges." :
          n < 7 ? "Raised eyebrows at the garden party." :
          n < 12 ? "Whispers become a scandal." :
          "Society is in shambles.";
      }

      function setDigest(text){
        $("digestBox").textContent = text;
        $("stamp").textContent = "Last run: " + new Date().toLocaleString();
      }

      // ===== MAP INIT (this was the part that was breaking) =====
      const map = L.map("map", { zoomControl: true }).setView([HOME.lat, HOME.lon], 16);

      // Force a size calc after layout paints (prevents blank map in some cases)
      setTimeout(() => map.invalidateSize(), 50);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap contributors"
      }).addTo(map);

      const hqMarker = L.marker([HOME.lat, HOME.lon], { draggable: true })
        .addTo(map)
        .bindPopup("üè† HQ ‚Äî drag to the exact roof, darling.")
        .openPopup();

      const radiusCircle = L.circle([HOME.lat, HOME.lon], {
        radius: radiusMiles * 1609.34,
        color: "#b48a3c",
        weight: 2,
        fillOpacity: 0.06
      }).addTo(map);

      hqMarker.on("dragend", async () => {
        const ll = hqMarker.getLatLng();
        HOME = { lat: ll.lat, lon: ll.lng };
        saveHome(HOME.lat, HOME.lon);
        radiusCircle.setLatLng([HOME.lat, HOME.lon]);
        await refresh();
      });

      let markers = new Map();

      function clearPins(){
        for (const m of markers.values()) map.removeLayer(m);
        markers.clear();
      }

      function addSirenMarker(a){
        const lat = Number(a.Latitude);
        const lon = Number(a.Longitude);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

        const id = makeCaseId(a);
        if (markers.has(id)) return;

        const icon = L.divIcon({
          className: "",
          html: `<div style="
            width: 26px; height: 26px; display:grid; place-items:center;
            border-radius: 999px;
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(0,0,0,0.12);
            box-shadow: 0 8px 22px rgba(0,0,0,0.12);
            font-size: 16px;
          ">üö®</div>`,
          iconSize: [26, 26],
          iconAnchor: [13, 13]
        });

        const m = L.marker([lat, lon], { icon }).addTo(map);

        const type = a.CaseType || "311";
        const status = a.StateCodeName || a.Status || "Unknown";
        const address = a.IncidentAddress || "‚Äî";
        const caseNum = a.CaseNumber365 || a.CaseNumber || "‚Äî";

        m.bindPopup(`
          <div style="font-family:Georgia,serif; line-height:1.45;">
            <div style="font-size:16px; font-weight:700;">${type}</div>
            <div style="color:#6f6a64;">${address}</div>
            <div style="margin-top:6px;">Status: <b>${status}</b></div>
            <div style="margin-top:6px;">Case #: <b>${caseNum}</b></div>
            <div style="margin-top:8px;">
              <a class="caseLink" href="${CASE_STATUS_URL}" target="_blank" rel="noopener noreferrer">
                Open Houston 311 case status
              </a>
            </div>
            <div style="margin-top:6px; color:#6f6a64; font-size:12px;">
              (Houston‚Äôs site doesn‚Äôt reliably accept pre-filled links‚Äîcopy/paste the case # above.)
            </div>
          </div>
        `);

        markers.set(id, m);
      }

      async function refresh(){
        $("radiusLabel").textContent = radiusMiles.toFixed(2);
        radiusCircle.setRadius(radiusMiles * 1609.34);

        setDigest("Gathering whispers‚Ä¶");

        try {
          clearPins();

          const url = buildArcgisUrl();
          const res = await fetch(url);
          const data = await res.json();

          const feats = (data.features || []).map(f => f.attributes || {});
          const parkingOnly = $("parkingOnly").checked;
          const excludeTraffic = $("excludeTraffic").checked;

          const lines = [];
          let shown = 0;

          for (const a of feats) {
            const type = a.CaseType || "";

            if (excludeTraffic && isTraffic(type)) continue;
            if (parkingOnly && !isParking(type)) continue;

            shown++;
            addSirenMarker(a);

            const caseNum = a.CaseNumber365 || a.CaseNumber || "‚Äî";
            lines.push(`‚Ä¢ ${a.CaseType || "311"} ‚Äî ${a.IncidentAddress || "‚Äî"} (Case ${caseNum})`);
          }

          setChaos(shown);

          if (shown === 0) {
            setDigest("It appears the curbside remains unremarkable today.\n\n(If you expected results, try unchecking ‚ÄúParking only‚Äù or increasing the radius.)");
          } else {
            setDigest(lines.join("\n"));
          }

          // Recenter gently to HQ if map was blank before
          map.setView([HOME.lat, HOME.lon], map.getZoom());

        } catch (err) {
          console.error(err);
          setChaos(0);
          setDigest(
            "The messenger has fainted.\n\n" +
            "What I know:\n" +
            "- The map should still render even if the data fails.\n" +
            "- If this message appears, a request or script crashed.\n\n" +
            "Error:\n" + String(err)
          );
        }
      }

      // ===== UI wiring =====
      $("radiusLabel").textContent = radiusMiles.toFixed(2);
      $("radius").addEventListener("input", async (e) => {
        radiusMiles = Number(e.target.value);
        await refresh();
      });

      $("refreshBtn").addEventListener("click", refresh);
      $("parkingOnly").addEventListener("change", refresh);
      $("excludeTraffic").addEventListener("change", refresh);

      // First run
      refresh();
    });
  </script>
</body>
</html>

