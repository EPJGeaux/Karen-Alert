<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Whispers from the Curb</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --paper: #fbfaf7;
      --ink: #1e1b18;
      --muted: #6f6a64;
      --accent: #b48a3c;
      --line: #e6e2db;
      --soft: #f3f1ec;
      --radius: 18px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--paper);
      color: var(--ink);
      font-family: "Playfair Display", Georgia, serif;
    }

    body{
      display: flex;
      justify-content: center;
    }

    .page{
      width: min(1100px, 100%);
      padding: 28px 20px 40px;
      box-sizing: border-box;
    }

    /* TITLE */
    .masthead{
      text-align: center;
      margin-bottom: 26px;
    }

    .masthead h1{
      font-size: 44px;
      margin: 0;
      letter-spacing: 0.5px;
    }

    .masthead p{
      margin: 8px 0 0;
      font-size: 15px;
      color: var(--muted);
      font-style: italic;
    }

    .rule{
      margin: 22px 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--line), transparent);
    }

    /* CHAOS */
    .chaos{
      background: var(--soft);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px 18px;
      text-align: center;
      margin-bottom: 18px;
    }

    .chaos strong{
      font-size: 13px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .chaos .count{
      font-size: 40px;
      margin-top: 6px;
      color: var(--accent);
    }

    .chaos .label{
      margin-top: 4px;
      font-size: 14px;
      color: var(--muted);
    }

    /* MAP */
    #map{
      height: 360px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      margin-bottom: 18px;
    }

    /* CONTROLS */
    .controls{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    .controls button,
    .controls input{
      font-family: inherit;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .controls label{
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    /* DIGEST */
    .digest{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 20px;
    }

    .digest h2{
      margin: 0 0 12px;
      font-size: 22px;
    }

    .digest pre{
      white-space: pre-wrap;
      font-family: "Georgia", serif;
      font-size: 14px;
      line-height: 1.55;
      margin: 0;
    }

    a.caseLink{
      color: var(--accent);
      font-weight: 600;
      text-decoration: underline;
    }

    .leaflet-control-zoom a{
      background: #fff !important;
      border: 1px solid var(--line) !important;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="masthead">
      <h1>Whispers from the Curb</h1>
      <p>Dearest reader, oneâ€™s neighborhood rarely rests quietlyâ€¦</p>
    </div>

    <div class="rule"></div>

    <div class="chaos">
      <strong>Current State of Affairs</strong>
      <div class="count" id="chaosCount">0</div>
      <div class="label" id="chaosLabel">All is calm</div>
    </div>

    <div id="map"></div>

    <div class="controls">
      <button id="refreshBtn">Refresh intelligence</button>
      <label><input type="checkbox" id="parkingOnly" checked> Parking only</label>
      <label><input type="checkbox" id="excludeTraffic" checked> Exclude traffic</label>
    </div>

    <div class="digest">
      <h2>ðŸ“° The Daily Dispatch</h2>
      <pre id="digestBox">Gathering whispersâ€¦</pre>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const HOME = { lat: 29.828103, lon: -95.426829 };
    const RADIUS_MI = 1.0;
    const $ = id => document.getElementById(id);

    function isTraffic(t){
      return (t||"").toLowerCase().includes("traffic");
    }
    function isParking(t){
      return (t||"").toLowerCase().match(/park|vehicle|tow|driveway|abandoned/);
    }

    const map = L.map("map").setView([HOME.lat, HOME.lon], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    L.marker([HOME.lat, HOME.lon]).addTo(map).bindPopup("Your residence");

    let markers = [];

    function clearPins(){
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function buildURL(){
      const latPad = RADIUS_MI / 69;
      const lonPad = RADIUS_MI / (69 * Math.cos(HOME.lat * Math.PI/180));
      return `https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query` +
        `?where=Latitude BETWEEN ${HOME.lat-latPad} AND ${HOME.lat+latPad}` +
        ` AND Longitude BETWEEN ${HOME.lon-lonPad} AND ${HOME.lon+lonPad}` +
        `&out
