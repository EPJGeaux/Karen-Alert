<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Houston Karen Command Center</title>

  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    #map { height: 100%; width: 100%; }

    #controls {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      z-index: 1000;
      font-size: 14px;
    }

    #title {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.65);
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 13px;
      z-index: 1000;
    }
  </style>
</head>

<body>

<div id="controls">
  <strong>Active Karen Alerts</strong>
  <div>Radius: 1 mile</div>
</div>

<div id="title">Houston Karen Command Center</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
console.log("LOCKED-IN BUILD");

const HOME = { lat: 29.828103, lon: -95.426829 };
const RADIUS_MILES = 1.0;

/* üî• ONLY ACTIVE + EXCLUDE TRAFFIC SPAM */
const apiURL =
  "https://mycity2.houstontx.gov/pubgis01/rest/services/311/Houston311_RecentServiceRequests/FeatureServer/3/query?" +
  "where=StateCodeName='Active' AND NOT CaseType LIKE '%Traffic%'" +
  "&outFields=CaseType,Status,Latitude,Longitude,IncidentAddress,CaseNumber" +
  "&resultRecordCount=2000&f=json";

const map = L.map("map", { zoomControl: true })
             .setView([HOME.lat, HOME.lon], 15);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
  .addTo(map);

/* üè† HARD LOCK CENTER */
L.marker([HOME.lat, HOME.lon])
  .addTo(map)
  .bindPopup("üè† Karen HQ")
  .openPopup();

/* üîµ Visual Radius */
L.circle([HOME.lat, HOME.lon], {
  radius: RADIUS_MILES * 1609.34,
  fillOpacity: 0.05
}).addTo(map);

let markers = {};
let knownCases = new Set();

function milesBetween(lat1, lon1, lat2, lon2) {
  const R = 3958.8;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function addMarker(attrs, distance) {
  const id = attrs.CaseNumber || Math.random();

  const marker = L.circleMarker(
    [attrs.Latitude, attrs.Longitude],
    { radius: 8 }
  )
  .addTo(map)
  .bindPopup(
    "<b>" + attrs.CaseType + "</b><br>" +
    "Status: " + attrs.Status + "<br>" +
    "Distance: " + distance.toFixed(2) + " mi<br>" +
    attrs.IncidentAddress
  );

  /* üî• NEW CASE ANIMATION */
  marker.setStyle({ opacity: 0, fillOpacity: 0 });

  setTimeout(() => {
    marker.setStyle({ opacity: 1, fillOpacity: 0.7 });
  }, 50);

  markers[id] = marker;
}

function refresh() {
  fetch(apiURL)
    .then(r => r.json())
    .then(data => {
      const features = data.features || [];
      console.log("Active records:", features.length);

      features.forEach(f => {
        const attrs = f.attributes;
        if (!attrs || !attrs.Latitude || !attrs.Longitude) return;

        const distance = milesBetween(
          HOME.lat, HOME.lon,
          attrs.Latitude, attrs.Longitude
        );

        if (distance > RADIUS_MILES) return;

        const id = attrs.CaseNumber;
        if (knownCases.has(id)) return;

        knownCases.add(id);
        addMarker(attrs, distance);
      });
    });
}

/* Initial load */
refresh();

/* üîÅ Auto-refresh every 30 sec */
setInterval(refresh, 30000);
</script>

</body>
</html>
